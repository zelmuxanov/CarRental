@model (CarRental.BLL.DTOs.Car.CarDto Car, CarRental.Web.ViewModels.Car.BookCarViewModel? BookingModel)
@{
    ViewData["Title"] = $"{Model.Car?.Brand} {Model.Car?.Model} - –î–µ—Ç–∞–ª–∏";
    Layout = "_Layout";
    
    var pricePerDay = Model.Car?.PricePerDay ?? 0;
    var pricePerDayJs = pricePerDay.ToString(System.Globalization.CultureInfo.InvariantCulture);
    var isAuthenticated = User?.Identity?.IsAuthenticated == true;
    var bookingModel = Model.BookingModel;
    var car = Model.Car;
}

<div class="container mt-4">
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ç–æ + –æ–ø–∏—Å–∞–Ω–∏–µ -->
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(car?.ImageUrl))
            {
                <img src="@car.ImageUrl" class="img-fluid rounded car-details-image" alt="@car.Brand @car.Model">
            }
            else
            {
                <div class="bg-light d-flex align-items-center justify-content-center rounded car-details-no-image">
                    <span class="text-muted">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                </div>
            }
            
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥ —Ñ–æ—Ç–æ -->
            @if (!string.IsNullOrEmpty(car?.Description))
            {
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">–û–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h5>
                    </div>
                    <div class="card-body">
                        <p>@car.Description</p>
                    </div>
                </div>
            }
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="col-md-6">
            <h1 class="mb-3">@car?.Brand @car?.Model</h1>
            
            <!-- –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>–ö–ª–∞—Å—Å:</strong><br>@car?.Class</p>
                            <p class="mb-2"><strong>–ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á:</strong><br>@car?.Transmission</p>
                            <p class="mb-2"><strong>–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞:</strong><br>@car?.FuelType</p>
                            <p class="mb-2"><strong>–¶–≤–µ—Ç:</strong><br>@car?.Color</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</strong><br>@car?.Year</p>
                            <p class="mb-2"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç:</strong><br>@car?.Seats</p>
                            <p class="mb-2"><strong>–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong><br>@car?.EngineCapacity –ª</p>
                            <p class="mb-2"><strong>–ì–æ—Å. –Ω–æ–º–µ—Ä:</strong><br>@car?.LicensePlate</p>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(car?.VIN))
                    {
                        <div class="mt-2">
                            <strong>VIN:</strong><br><small class="text-muted">@car.VIN</small>
                        </div>
                    }
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —Ü–µ–Ω–æ–π –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h2 class="text-success">@car?.PricePerDay.ToString("C")</h2>
                        <span class="text-muted">–∑–∞ —Å—É—Ç–∫–∏</span>
                    </div>
                    
                    @if (isAuthenticated)
                    {
                        <button class="btn btn-primary btn-lg w-100 mb-3" data-bs-toggle="modal" data-bs-target="#bookingModal">
                            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <p class="mb-2">–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                            <div>
                                <a href="/Account/Login" class="btn btn-primary me-2">–í–æ–π—Ç–∏</a>
                                <a href="/Account/Register" class="btn btn-success">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                            </div>
                        </div>
                    }
                    
                    <a href="@Url.Action("Index", "Car")" class="btn btn-outline-secondary w-100">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: @car?.Brand @car?.Model</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (isAuthenticated && bookingModel != null)
                {
                    <form method="post" asp-action="BookCar" id="bookingForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="CarId" value="@car?.Id" />
                        
                        <div class="mb-3">
                            <label for="StartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                            <input type="date" id="StartDate" name="StartDate" 
                                   class="form-control" min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")"
                                   value="@bookingModel.StartDate.ToString("yyyy-MM-dd")" required>
                            <small class="text-muted">–ù–µ —Ä–∞–Ω–µ–µ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="EndDate" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                            <input type="date" id="EndDate" name="EndDate" 
                                   class="form-control" min="@DateTime.Today.AddDays(4).ToString("yyyy-MM-dd")"
                                   value="@bookingModel.EndDate.ToString("yyyy-MM-dd")" required>
                            <small class="text-muted">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã - 3 –¥–Ω—è</small>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="needDelivery" name="NeedDelivery" value="true">
                                <label class="form-check-label" for="needDelivery">
                                    –ù—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞?
                                </label>
                            </div>
                        </div>

                        <div class="mb-3 delivery-options" style="display: none;">
                            <label class="form-label">–ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å?</label>
                            <select name="DeliveryLocation" class="form-select" id="deliveryLocation">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏</option>
                                <option value="Sheremetyevo">–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ - 4500 ‚ÇΩ</option>
                                <option value="Vnukovo">–ê—ç—Ä–æ–ø–æ—Ä—Ç –í–Ω—É–∫–æ–≤–æ - 3500 ‚ÇΩ</option>
                                <option value="Domodedovo">–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ - 6000 ‚ÇΩ</option>
                                <option value="Moscow">–ü–æ –ú–æ—Å–∫–≤–µ –∏ –ú–û (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ)</option>
                            </select>
                            <small class="text-muted">–í—ã–µ–∑–¥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ú–û –æ–±–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ</small>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="unlimitedMileage" name="UnlimitedMileage" value="true">
                                <label class="form-check-label" for="unlimitedMileage">
                                    –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –ø—Ä–æ–±–µ–≥ (+2000 ‚ÇΩ/—Å—É—Ç–∫–∏)
                                </label>
                            </div>
                            <small class="text-muted">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–∏–º–∏—Ç: 250 –∫–º –≤ –¥–µ–Ω—å. –° –±–µ–∑–ª–∏–º–∏—Ç–æ–º - –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ</small>
                        </div>
                        
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-6">
                                    <strong>–ü–µ—Ä–∏–æ–¥:</strong>
                                    <div id="rentalPeriod">3 –¥–Ω—è</div>
                                </div>
                                <div class="col-6 text-end">
                                    <strong>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong>
                                    <div class="text-success fw-bold fs-5" id="totalPrice">@((car?.PricePerDay * 3)?.ToString("C"))</div>
                                </div>
                            </div>
                            <div class="mt-2 small text-muted" id="priceBreakdown">
                                @car?.PricePerDay.ToString("C")/—Å—É—Ç–∫–∏
                            </div>
                        </div>

                        <!-- –¢–µ–∫—Å—Ç –ø—Ä–æ –¥–ª–∏—Ç–µ–ª—å–Ω—É—é –∞—Ä–µ–Ω–¥—É -->
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>‚ÑπÔ∏è –î–ª–∏—Ç–µ–ª—å–Ω–∞—è –∞—Ä–µ–Ω–¥–∞:</strong> 
                                –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 30 –¥–Ω–µ–π —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º 
                                –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="text-center py-4">
                        <p class="lead">–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                        <div class="mt-3">
                            <a href="/Account/Login" class="btn btn-primary me-2">–í–æ–π—Ç–∏</a>
                            <a href="/Account/Register" class="btn btn-success">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('bookingModal').addEventListener('shown.bs.modal', function () {
            console.log('üéØ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à —Ä–∞–±–æ—á–∏–π —Å–∫—Ä–∏–ø—Ç
            const pricePerDay = @pricePerDayJs;
            
            console.log("üöó Car details loaded, pricePerDay:", pricePerDay);

            function calculateTotalPrice() {
                const startDate = new Date(document.getElementById('StartDate').value);
                const endDate = new Date(document.getElementById('EndDate').value);
                
                console.log("üìÖ Calculating price for dates:", startDate, "to", endDate);
                
                if (startDate && endDate && endDate > startDate) {
                    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    let basePrice = pricePerDay * days;
                    let deliveryPrice = 0;
                    let unlimitedPrice = 0;
                    
                    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
                    const needDelivery = document.getElementById('needDelivery').checked;
                    const deliveryLocation = document.getElementById('deliveryLocation').value;
                    
                    if (needDelivery) {
                        switch(deliveryLocation) {
                            case 'Sheremetyevo': deliveryPrice = 4500; break;
                            case 'Vnukovo': deliveryPrice = 3500; break;
                            case 'Domodedovo': deliveryPrice = 6000; break;
                            case 'Moscow': deliveryPrice = 0; break;
                        }
                    }
                    
                    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –±–µ–∑–ª–∏–º–∏—Ç–∞
                    const unlimitedMileage = document.getElementById('unlimitedMileage').checked;
                    if (unlimitedMileage) {
                        unlimitedPrice = 2000 * days;
                    }
                    
                    const totalPrice = basePrice + deliveryPrice + unlimitedPrice;
                    
                    console.log("üí∞ Price calculation:", {
                        days: days,
                        basePrice: basePrice,
                        deliveryPrice: deliveryPrice,
                        unlimitedPrice: unlimitedPrice,
                        totalPrice: totalPrice
                    });
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    document.getElementById('totalPrice').textContent = formatPrice(totalPrice);
                    document.getElementById('rentalPeriod').textContent = days + ' ' + getDaysText(days);
                    
                    // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                    let breakdown = formatPrice(pricePerDay) + ' √ó ' + days + ' ' + getDaysText(days);
                    
                    if (deliveryPrice > 0) {
                        breakdown += '<br>+ –î–æ—Å—Ç–∞–≤–∫–∞: ' + formatPrice(deliveryPrice);
                    }
                    
                    if (unlimitedPrice > 0) {
                        breakdown += '<br>+ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –ø—Ä–æ–±–µ–≥: ' + formatPrice(unlimitedPrice);
                    }
                    
                    document.getElementById('priceBreakdown').innerHTML = breakdown;
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Å—Ä–æ–∫–∞
                    if (days < 3) {
                        document.getElementById('EndDate').setCustomValidity('–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã - 3 –¥–Ω—è');
                    } else {
                        document.getElementById('EndDate').setCustomValidity('');
                    }
                }
            }
            
            function formatPrice(price) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB',
                    minimumFractionDigits: 0
                }).format(price);
            }
            
            function getDaysText(days) {
                if (days % 10 === 1 && days % 100 !== 11) return '–¥–µ–Ω—å';
                if (days % 10 >= 2 && days % 10 <= 4 && (days % 100 < 10 || days % 100 >= 20)) return '–¥–Ω—è';
                return '–¥–Ω–µ–π';
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const startDateInput = document.getElementById('StartDate');
            const endDateInput = document.getElementById('EndDate');
            const needDeliveryCheckbox = document.getElementById('needDelivery');
            const deliveryLocationSelect = document.getElementById('deliveryLocation');
            const deliveryOptions = document.querySelector('.delivery-options');
            const unlimitedMileageCheckbox = document.getElementById('unlimitedMileage');
            
            if (startDateInput && endDateInput) {
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                startDateInput.addEventListener('change', function() {
                    const startDate = new Date(this.value);
                    const minEndDate = new Date(startDate);
                    minEndDate.setDate(minEndDate.getDate() + 3);
                    endDateInput.min = minEndDate.toISOString().split('T')[0];
                    
                    const endDate = new Date(endDateInput.value);
                    if (endDate < minEndDate) {
                        endDateInput.value = minEndDate.toISOString().split('T')[0];
                    }
                    
                    calculateTotalPrice();
                });
                
                endDateInput.addEventListener('change', calculateTotalPrice);
                
                if (needDeliveryCheckbox) {
                    needDeliveryCheckbox.addEventListener('change', function() {
                        if (deliveryOptions) {
                            deliveryOptions.style.display = this.checked ? 'block' : 'none';
                        }
                        calculateTotalPrice();
                    });
                }
                
                if (deliveryLocationSelect) {
                    deliveryLocationSelect.addEventListener('change', calculateTotalPrice);
                }
                
                if (unlimitedMileageCheckbox) {
                    unlimitedMileageCheckbox.addEventListener('change', calculateTotalPrice);
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                calculateTotalPrice();
                console.log("‚úÖ Car booking form initialized successfully in modal");
            }
        });

        // –¢–∞–∫–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöó –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ç–∞–ª–µ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üí∞ –¶–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏:', @pricePerDayJs);
            
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ (–ø—Ä–∏ –ø—Ä—è–º–æ–º –¥–æ—Å—Ç—É–ø–µ —Å —è–∫–æ—Ä–µ–º)
            if (document.getElementById('bookingModal').classList.contains('show')) {
                console.log('üîç –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä');
                const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            }
        });
    </script>
}