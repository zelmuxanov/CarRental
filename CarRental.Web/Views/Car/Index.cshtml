@model IEnumerable<CarRental.BLL.DTOs.Car.CarDto>
@{
    ViewData["Title"] = "–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π";
    Layout = "_Layout";
}

<div class="container mt-4">
    <h1 class="mb-4">–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h1>

    <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Search" method="get" class="row g-3" id="searchForm">
                <div class="col-md-4">
                    <label class="form-label">–ú–∞—Ä–∫–∞</label>
                    <select name="brand" class="form-select" id="brandSelect">
                        <option value="">–í—Å–µ –º–∞—Ä–∫–∏</option>
                        @if (ViewBag.Brands != null)
                        {
                            @foreach (var brand in ViewBag.Brands)
                            {
                                var isSelected = ViewBag.CurrentBrand == brand;
                                <option value="@brand" selected="@isSelected">@brand</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                    <select name="model" class="form-select" id="modelSelect">
                        <option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
                        @if (ViewBag.Models != null)
                        {
                            @foreach (var modelItem in ViewBag.Models)
                            {
                                var isSelected = ViewBag.CurrentModel == modelItem;
                                <option value="@modelItem" selected="@isSelected">@modelItem</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">–ú–∞–∫—Å. —Ü–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏ (‚ÇΩ)</label>
                    <input type="number" name="maxPrice" class="form-control" placeholder="10000"
                           value="@ViewBag.CurrentMaxPrice" id="maxPriceInput">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100 me-2">–ü–æ–∏—Å–∫</button>
                </div>
            </form>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            @if (ViewBag.HasActiveFilters == true)
            {
                <div class="mt-3">
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-sm">
                        ‚úñ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="alert alert-info @(ViewBag.HasActiveFilters == true ? "" : "d-none")" id="diagnosticInfo">
        <strong>üìä –§–∏–ª—å—Ç—Ä—ã:</strong> 
        <span id="searchParams">
            @if (!string.IsNullOrEmpty(ViewBag.CurrentBrand))
            {
                <span class="badge bg-primary">–ú–∞—Ä–∫–∞: @ViewBag.CurrentBrand</span>
            }
            @if (!string.IsNullOrEmpty(ViewBag.CurrentModel))
            {
                <span class="badge bg-primary ms-2">–ú–æ–¥–µ–ª—å: @ViewBag.CurrentModel</span>
            }
            @if (!string.IsNullOrEmpty(ViewBag.CurrentMaxPrice))
            {
                <span class="badge bg-primary ms-2">–¶–µ–Ω–∞ –¥–æ: @ViewBag.CurrentMaxPrice‚ÇΩ/—Å—É—Ç</span>
            }
        </span>
        <span class="ms-2">
            –ù–∞–π–¥–µ–Ω–æ: <strong>@(Model?.Count() ?? 0)</strong> –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        </span>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    <div class="row mt-4">
        <div class="col-12">
            <h2 class="mb-3">
                –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏: 
                <span class="badge bg-primary fs-6">@(Model?.Count() ?? 0)</span>
            </h2>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π -->
    @if (Model != null && Model.Any())
    {
        <div class="row">
            @foreach (var car in Model)
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 car-card shadow-sm">
                        @if (!string.IsNullOrEmpty(car.ImageUrl))
                        {
                            <img src="@car.ImageUrl" class="card-img-top" alt="@car.Brand @car.Model" 
                                 style="height: 200px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                                 style="height: 200px;">
                                <span class="text-muted">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                            </div>
                        }
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@car.Brand @car.Model</h5>
                            <p class="card-text">
                                <small class="text-muted">
                                    @car.Year –≥–æ–¥ ¬∑ @car.Class<br>
                                    @car.Transmission ¬∑ @car.FuelType<br>
                                    @car.Seats –º–µ—Å—Ç ¬∑ @car.EngineCapacity –ª
                                </small>
                            </p>
                            <p class="card-text">
                                @if (car.IsAvailable)
                                {
                                    <span class="badge bg-success">–î–æ—Å—Ç—É–ø–µ–Ω</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω</span>
                                }
                            </p>
                            <p class="card-text mt-auto">
                                <strong class="text-success fs-5">@car.PricePerDay.ToString("C") / —Å—É—Ç–∫–∏</strong>
                            </p>
                            <div class="mt-auto">
                                <a href="@Url.Action("Details", "Car", new { id = car.Id })" 
                                   class="btn btn-primary w-100">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-5">
            <h4>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
            <div class="mt-3">
                <a href="@Url.Action("Index")" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        console.log("üîç Search page loaded");
        console.log("Current brand:", '@ViewBag.CurrentBrand');
        console.log("Current model:", '@ViewBag.CurrentModel');
        console.log("Current max price:", '@ViewBag.CurrentMaxPrice');
        console.log("Has filters:", @(ViewBag.HasActiveFilters == true ? "true" : "false"));
        console.log("Car count:", @(Model?.Count() ?? 0));
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('brandSelect')?.addEventListener('change', function() {
            console.log('Brand changed to:', this.value);
            document.getElementById('searchForm').submit();
        });
        
        document.getElementById('modelSelect')?.addEventListener('change', function() {
            console.log('Model changed to:', this.value);
            document.getElementById('searchForm').submit();
        });
        
        document.getElementById('maxPriceInput')?.addEventListener('change', function() {
            console.log('Max price changed to:', this.value);
            document.getElementById('searchForm').submit();
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            if (@(Model?.Count() ?? 0) > 0) {
                console.log('üéâ Cars loaded successfully');
            } else {
                console.log('‚ö†Ô∏è No cars found');
            }
        });
    </script>
}