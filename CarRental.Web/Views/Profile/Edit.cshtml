@model CarRental.Web.ViewModels.Profile.EditProfileViewModel
@{
    ViewData["Title"] = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è";
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <partial name="_ProfileNavigation" />
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                </div>
                <div class="card-body">
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- –û–∫–Ω–æ —Å –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–±—ã–≤—à–∞—è –≤–∫–ª–∞–¥–∫–∞) -->
                    <div class="personal-data-section">
                        <h5 class="mb-4">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                        
                        <form method="post" asp-action="Edit">
                            @Html.AntiForgeryToken()

                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger">
                                    <ul class="mb-0">
                                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                        {
                                            <li>@error.ErrorMessage</li>
                                        }
                                    </ul>
                                </div>
                            }

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="FirstName" class="form-label fw-bold">–ò–º—è *</label>
                                        <input type="text" id="FirstName" name="FirstName" class="form-control" 
                                               value="@Model?.FirstName" required />
                                        <span asp-validation-for="FirstName" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="LastName" class="form-label fw-bold">–§–∞–º–∏–ª–∏—è *</label>
                                        <input type="text" id="LastName" name="LastName" class="form-control" 
                                               value="@Model?.LastName" required />
                                        <span asp-validation-for="LastName" class="text-danger small"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="PhoneNumber" class="form-label fw-bold">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                                <input type="tel" id="PhoneNumber" name="PhoneNumber" class="form-control" 
                                    value="@Model?.PhoneNumber" placeholder="+7 (___) ___-__-__" required />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                                <div class="form-text">–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX</div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="@Url.Action("Index", "Profile")" class="btn btn-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
                                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script>
        $(document).ready(function() {    
            $('#PhoneNumber').inputmask({
                mask: '+7 (999) 999-99-99',
                placeholder: '_',
                clearIncomplete: true,
                showMaskOnHover: true,
                onBeforeMask: function(value, opts) {
                    if (!value) return value;
                    
                    console.log('Before mask:', value);
                    
                    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                    let digits = value.replace(/\D/g, '');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    let originalValue = value;
                    
                    // –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–º–µ—Ä, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å 9, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç–æ
                    if (originalValue.includes('9') && digits.length >= 10) {
                        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–π 9 –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                        let firstNineIndex = originalValue.indexOf('9');
                        if (firstNineIndex >= 0 && firstNineIndex <= 3) {
                            // –ï—Å–ª–∏ 9 –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ
                            if (digits.length === 10) {
                                return digits; // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å - –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 9
                            } else if (digits.length === 11 && digits.startsWith('9')) {
                                return digits.substring(1); // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω—é—é —Ü–∏—Ñ—Ä—É –≤ –Ω–∞—á–∞–ª–µ
                            }
                        }
                    }
                    
                    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
                    if (digits.length === 11) {
                        if (digits.startsWith('7') || digits.startsWith('8')) {
                            return digits.substring(1);
                        }
                    } else if (digits.length > 11) {
                        digits = digits.substring(digits.length - 10);
                    }
                    
                    return digits;
                }
            });
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ä–∞–±–æ—Ç—ã —Å 9
            $('#PhoneNumber').on('paste', function(e) {
                let clipboardData = e.originalEvent.clipboardData || window.clipboardData;
                let pastedData = clipboardData.getData('Text');
                
                if (pastedData && pastedData.includes('9')) {
                    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å—Ç–∞–≤–∫–∏
                    setTimeout(() => {
                        let currentValue = $(this).val();
                        // –ï—Å–ª–∏ –º–∞—Å–∫–∞ –¥–æ–±–∞–≤–∏–ª–∞ +7 (7, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ +7 (9
                        if (currentValue && currentValue.startsWith('+7 (7')) {
                            let correctedValue = '+7 (9' + currentValue.substring(5);
                            $(this).val(correctedValue);
                        }
                    }, 100);
                }
            });
        });
    
    </script>
}